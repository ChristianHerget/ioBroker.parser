<html>
<head>
<link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>
<script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>
<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>

<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>
<!--script type="text/javascript" src="lib/js/cron/jquery.cron.js"></script>
<script type="text/javascript" src="lib/js/cron/cron2text.js"></script-->
<script type="text/javascript" src="words.js"></script>


<style>
    .number {
        width: 70px
    }
    .table-values th {
        background: #686868;
        color: #FFF;
        font-weight: bold;
    }
    .table-values tr:nth-child(even) {
        background: #d0d0d0;
    }
    .error {
        border: 1px solid red;
    }
</style>

<script type="text/javascript">
    var values = [];
    /*
     <div id="values">
     <button class="table-button-add" style="margin-left: 10px"></button>
     <table class="table-values" style="width: 100%; calc(100% - 200px)">
     <thead>
     <tr>
     <th data-name="regex"     style="width: 30%" class="translate">Context</th>
     <th data-name="room"      class="translate" data-type="select">Room</th>
     <th data-name="aaa"       class="translate" data-options="1/A;2/B;3/C;4" data-type="select">Room</th>
     <th data-name="enabled"   class="translate" data-type="checkbox">Enabled</th>
     <th data-buttons="delete up down" style="width: 32px"></th>
     </tr>
     </thead>
     </table>
     </td>
     */

    /**
     * Create edit table from javascript array.
     *
     * This function creates a html edit table.
     *
     * <pre><code>
     *   <div id="values" style="width: 100%; height: calc(100% - 205px)">
     *      <button class="table-button-add" style="margin-left: 10px"></button>
     *      <div style="width: 100%; height: calc(100% - 30px); overflow: auto;">
     *          <table class="table-values" style="width: 100%;">
     *              <thead>
     *                  <tr>
     *                      <th data-name="_index" style="30px" data-style="width: 100%; text-align: right">Context</th>
     *                      <th data-name="regex"     class="translate" style="width: 30%" data-style="text-align: right">Context</th>
     *                      <th data-name="room"      class="translate" data-type="select">Room</th>
     *                      <th data-name="aaa"       class="translate" data-options="1/A;2/B;3/C;4" data-type="select">Room</th>
     *                      <th data-name="enabled"   class="translate" data-type="checkbox">Enabled</th>
     *                      <th data-buttons="delete up down" style="width: 32px"></th>
     *                  </tr>
     *              </thead>
     *          </table>
     *      </div>
     *   </div>
     * <pre><code>
     *
     * @param {string} id name of the html element (or empty).
     * @param {string} values data array
     * @param {function} onChange this function will be called if something changed
     * @param {function} onReady called, when the table is ready (may be to modify some elements of it)
     * @return {object} array with values
     */
    function _values2table(divId, values, onChange, onReady) {
        if (typeof values === 'function') {
            onChange = values;
            values   = divId;
            divId    = '';
        }

        values = values || [];
        var names = [];
        var $div;
        if (!divId) {
            $div = $('body');
        } else {
            $div = $('#' + divId);
        }
        var $add = $div.find('.table-button-add');

        if (!$add.data('inited')) {
            $add.data('inited', true);

            $add.button({
                icons: {primary: 'ui-icon-plus'},
                text: false
            })
            //.css({width: '1em', height: '1em'})
                .click(function () {
                    var $table = $div.find('.table-values');
                    var values = $table.data('values');
                    var names = $table.data('names');
                    var obj = {};
                    for (var i = 0; i < names.length; i++) {
                        if (!names[i]) continue;
                        obj[names[i].name] = names[i].def;
                    }
                    values.push(obj);
                    onChange && onChange();
                    setTimeout(function () {
                        _values2table(divId, values, onChange, onReady);
                    }, 100);
                });
        }

        if (values) {
            var buttons = [];
            var $table = $div.find('.table-values');
            $table.data('values', values);

            // load rooms
            if (!$table.data('rooms') && $table.find('th[data-name="room"]').length) {
                getEnums('rooms', function (err, list) {
                    var result = {};
                    result[_('none')] = '';
                    var nnames = [];
                    for (var n in list) {
                        nnames.push(n);
                    }
                    nnames.sort(function (a, b) {
                        a = a.toLowerCase();
                        b = b.toLowerCase();
                        if (a > b) return 1;
                        if (a < b) return -1;
                        return 0;
                    });

                    for (var l = 0; l < nnames.length; l++) {
                        result[nnames[l]] = list[nnames[l]].common.name || l;
                    }
                    $table.data('rooms', result);
                    _values2table(divId, values, onChange, onReady);
                });
                return;
            }
            // load functions
            if (!$table.data('functions') && $table.find('th[data-name="func"]').length) {
                getEnums('functions', function (err, list) {
                    var result = {};
                    result[_('none')] = '';
                    var nnames = [];
                    for (var n in list) {
                        nnames.push(n);
                    }
                    nnames.sort(function (a, b) {
                        a = a.toLowerCase();
                        b = b.toLowerCase();
                        if (a > b) return 1;
                        if (a < b) return -1;
                        return 0;
                    });

                    for (var l = 0; l < nnames.length; l++) {
                        result[nnames[l]] = list[nnames[l]].common.name || l;
                    }
                    $table.data('functions', result);
                    _values2table(divId, values, onChange, onReady);
                });
                return;
            }
            $table.find('th').each(function () {
                var name = $(this).data('name');
                if (name) {
                    var obj = {
                        name:    name,
                        type:    $(this).data('type') || 'text',
                        def:     $(this).data('default'),
                        style:   $(this).data('style')
                    };
                    if (obj.type === 'checkbox') {
                        if (obj.def === 'false') obj.def = false;
                        if (obj.def === 'true')  obj.def = true;
                        obj.def = !!obj.def;
                    } else if (obj.type === 'select') {
                        var vals = ($(this).data('options') || '').split(';');
                        obj.options = {};
                        for (var v = 0; v < vals.length; v++) {
                            var parts = vals[v].split('/');
                            obj.options[parts[0]] = _(parts[1] || parts[0]);
                            if (v === 0) obj.def = (obj.def === undefined) ? parts[0] : obj.def;
                        }
                    } else {
                        obj.def = obj.def || '';
                    }
                    names.push(obj);
                } else {
                    names.push(null);
                }

                name = $(this).data('buttons');

                if (name) {
                    var bs = name.split(' ');
                    buttons.push(bs);
                } else {
                    buttons.push(null);
                }
            });

            $table.data('names', names);

            var text = '';
            for (var v = 0; v < values.length; v++) {
                text += '<tr>';

                for (var i = 0; i < names.length; i++) {
                    text += '<td';
                    var line = '';
                    var style = '';
                    if (names[i]) {
                        if (names[i].name === '_index') {
                            style = (names[i].style ? names[i].style : 'text-align: right;');
                            line += (v + 1);
                        } else
                        if (names[i].type === 'checkbox') {
                            line += '<input ' + (names[i].style || '') + '" class="values-input" type="checkbox" data-index="' + v + '" data-name="' + names[i].name + '" ' + (values[v][names[i].name] ? 'checked' : '') + '" data-old-value="' + (values[v][names[i].name] === undefined ? '' : values[v][names[i].name]) + '"/>';
                        } else if (names[i].type === 'select') {
                            line += '<select style="' + (names[i].style ? names[i].style : 'width: 100%') + '" class="values-input" data-index="' + v + '" data-name="' + names[i].name + '">';
                            var options;
                            if (names[i].name === 'room') {
                                options = $table.data('rooms');
                            } else {
                                options = names[i].options;
                            }
                            var val = (values[v][names[i].name] === undefined ? '' : values[v][names[i].name]);
                            for (var p in options) {
                                line += '<option value="' + p + '" ' + (p === val ? ' selected' : '') + '>' + options[p] + '</option>';
                            }
                            line += '</select>';
                        } else {
                            line += '<input class="values-input" style="' + (names[i].style ? names[i].style : 'width: 100%') + '" type="' + names[i].type + '" data-index="' + v + '" data-name="' + names[i].name + '"/>';
                        }
                    }

                    if (buttons[i]) {
                        style = 'text-align: center;';
                        for (var b = 0; b < buttons[i].length; b++) {
                            if ((!v && buttons[i][b] === 'up') || v === values.length - 1 && buttons[i][b] === 'down') {
                                line += '<button data-command="' + buttons[i][b] + '" class="values-buttons" disabled>&nbsp;</button>';
                                continue;
                            }
                            line += '<button data-index="' + v + '" data-command="' + buttons[i][b] + '" class="values-buttons"></button>';
                        }
                    }
                    text += ' style="' + style + '">' + line + '</td>';
                }

                text += '</tr>';
            }
            var $lines = $('.table-lines');
            if (!$lines.length) {
                $table.append('<tbody class="table-lines"></tbody>');
                $lines = $('.table-lines');
            }

            $lines.html(text);

            $lines.find('.values-input').each(function () {
                var $this = $(this);
                var type = $this.attr('type');
                var name = $this.data('name');
                var id = $this.data('index');
                $this.data('old-value', values[id][name]);
                if (type === 'checkbox') {
                    $this.prop('checked', values[id][name]);
                } else {
                    $this.val(values[id][name]);
                }
            });
            $lines.find('.values-buttons').each(function () {
                var command = $(this).data('command');
                if (command === 'delete') {
                    $(this).button({
                        icons: {primary: 'ui-icon-trash'},
                        text: false
                    })
                        .css({width: '1em', height: '1em'})
                        .click(function () {
                            var id = $(this).data('index');
                            values.splice(id, 1);
                            onChange && onChange();
                            setTimeout(function () {
                                _values2table(divId, values, onChange, onReady);
                            }, 100);
                        });
                } else if (command === 'up') {
                    $(this).button({
                        icons: {primary: 'ui-icon-triangle-1-n'},
                        text: false
                    })
                        .css({width: '1em', height: '1em'})
                        .click(function () {
                            var id = $(this).data('index');
                            var elem = values[id];
                            values.splice(id, 1);
                            values.splice(id - 1, 0, elem);
                            onChange && onChange();
                            setTimeout(function () {
                                _values2table(id, values, onChange, onReady);
                            }, 100);
                        });
                } else if (command === 'down') {
                    $(this).button({
                        icons: {primary: 'ui-icon-triangle-1-s'},
                        text: false
                    })
                        .css({width: '1em', height: '1em'})
                        .click(function () {
                            var id = $(this).data('index');
                            var elem = values[id];
                            values.splice(id, 1);
                            values.splice(id + 1, 0, elem);
                            onChange && onChange();
                            setTimeout(function () {
                                _values2table(id, values, onChange, onReady);
                            }, 100);
                        });
                } else if (command === 'edit') {
                    $(this).button({
                        icons: {primary: 'ui-icon-pencil'},
                        text: false
                    })
                        .css({width: '1em', height: '1em'})
                        .click(function () {
                            var id = $(this).data('index');
                            var elem = values[id];
                            if (typeof editLine === 'function') {
                                setTimeout(function () {
                                    editLine(id, JSON.parse(JSON.stringify(values[id])), function (err, id, newValues) {
                                        if (!err) {
                                            if (JSON.stringify(values[id]) !== JSON.stringify(newValues)) {
                                                onChange && onChange();
                                                values[id] = newValues;
                                                _values2table(id, values, onChange, onReady);
                                            }                                        }
                                    });
                                }, 100);
                            }
                        });
                }
            });

            $lines.find('.values-input').change(function () {
                if ($(this).attr('type') === 'checkbox') {
                    if ($(this).prop('checked').toString() !== $(this).data('old-value')) onChange();
                    values[$(this).data('index')][$(this).data('name')] = $(this).prop('checked');
                } else {
                    if ($(this).val() !== $(this).data('old-value')) onChange();
                    values[$(this).data('index')][$(this).data('name')] = $(this).val();

                }
            }).keyup(function () {
                $(this).trigger('change');
            });
        }
        if (typeof onReady === 'function') onReady();
    }

    /**
     * Extract the values from table.
     *
     * This function extracts the values from edit table, that was generated with _values2table function.
     *
     * @param {string} id name of the html element (or nothing).
     * @return {object} array with values
     */
    function _table2values(divId) {
        var $div;
        if (!divId) {
            $div = $('body');
        } else {
            $div = $('#' + divId);
        }
        var names = [];
        $div.find('.table-values th').each(function () {
            var name = $(this).data('name');
            if (name) {
                names.push(name);
            } else {
                names.push('___ignore___');
            }
        });

        var values = [];
        var j = 0;
        $div.find('.table-lines tr').each(function () {
            values[j] = {};

            $(this).find('td').each(function () {
                var $input = $(this).find('input');
                if ($input.length) {
                    var name = $input.data('name');
                    if ($input.attr('type') === 'checkbox') {
                        values[j][name] = $input.prop('checked');
                    } else {
                        values[j][name] = $input.val();
                    }
                }
                var $select = $(this).find('select');
                if ($select.length) {
                    var name = $select.data('name');
                    values[j][name] = $select.val() || '';
                }
            });
            j++;
        });

        return values;
    }

    jQuery.fn.scrollToText = function(start, len) {
        var end = start + len;
        var e = $(this)[0]; // I don't know why... but $(this) don't want to work today :-/
        if (!e) return;

        else if (e.setSelectionRange) { e.focus(); e.setSelectionRange(start, end);} /* WebKit */
        else if (e.createTextRange) { var range = e.createTextRange(); range.collapse(true); range.moveEnd('character', end); range.moveStart('character', start); range.select(); } /* IE */
        else if (e.selectionStart) { e.selectionStart = start; e.selectionEnd = end; }

        return false;

    };

    function _showResult() {
        var test          = $('#dialog-edit-test-text').val();
        var regex         = $('#dialog-edit-regex').val();
        var type          = $('#dialog-edit-type').val();
        var offset        = $('#dialog-edit-offset').val();
        var item          = $('#dialog-edit-item').val();
        var factor        = $('#dialog-edit-factor').val();
        var substitute    = $('#dialog-edit-substitute').val();
        var substituteOld = $('#dialog-edit-substituteOld').prop('checked');
        if (!regex) regex = '.+';

        if (regex[0] === '/') regex = regex.substring(1, regex.length - 1);

        var comma = false;
        if (type === 'commaNumber') {
            comma = true;
            type = 'number';
        }

        if (substitute !== '' && substitute !== undefined && substitute !== null) {
            if (substitute === 'null')  substitute = null;

            if (type === 'number') {
                substitute = parseFloat(substitute) || 0;
            } else if (type === 'boolean') {
                if (substitute === 'true')  substitute = true;
                if (substitute === 'false') substitute = false;
                substitute = !!substitute;
            }
        } else {
            substitute = undefined;
        }

        $('#dialog-edit-error').html('');
        var len = regex.length;
        try {
            regex = new RegExp(regex, item ? 'g' : '');
        } catch (e) {
            $('#dialog-edit-error').html(e.toString());
            return;
        }
        offset = parseFloat(offset) || 0;
        factor = parseFloat(factor) || 1;
        item   = (parseFloat(item)  || 0)  + 1;
        if (item < 0) item = 1;
        if (item > 1000) item = 1000;
        var m;
        test = (test || '').toString().replace(/\r\n|[\r\n]/, ' ');
        do {
            m = regex.exec(test);
            item--;
        } while(item && m);

        if (m) {
            var newVal;
            var ll = m[1] ? m[0].indexOf(m[1]) : 0;
            $('#dialog-edit-test-text').data('select', {pos: m.index + ll, length: m[1] ? m[1].length : len});

            if (type === 'boolean') {
                newVal = true;
            } else  {
                newVal = m.length > 1 ? m[1] : m[0];
                if (type === 'number') {
                    // 1,000,000 => 1000000
                    if (!comma) newVal = newVal.replace(/,/g, '');
                    if (comma) {
                        // 1.000.000 => 1000000
                        newVal = newVal.replace(/\./g, '');
                        // 5,67 => 5.67
                        newVal = newVal.replace(',', '.');
                    }
                    // 1 000 000 => 1000000
                    newVal = newVal.replace(/\s/g, '');
                    newVal = parseFloat(newVal);
                    newVal *= factor;
                    newVal += offset;
                }
            }
            $('#dialog-edit-result').val(newVal);
        } else {
            if (type === 'boolean') {
                newVal = false;
                $('#dialog-edit-result').val(newVal);
            } else  {
                $('#dialog-edit-result').val(substitute);
            }
        }
    }

    var timeout;
    function showResult() {
        if (timeout) clearTimeout(timeout);
        timeout = setTimeout(_showResult, 400);
    }

    function editLine(id, line, callback) {
        sendTo(null, 'link', line.link, function (result) {
            if (result) {
                if (result.error) {
                    showMessage(result.error, _('Error'), 'alert');
                } else {
                    $('#dialog-edit-test-text').val(result.text || '');
                }
            }
        });

        $('.test-input').each(function () {
            var $this = $(this);
            var attr = $this.data('name');
            if ($this.attr('type') === 'checkbox') {
                $this.prop('checked', line[attr]);
            } else {
                $this.val(line[attr]);
            }
        });
        var $dialog = $('#dialog-test');
        if (!$dialog.data('inited')) {
            $dialog.data('inited', true);
            $dialog.dialog({
                autoOpen: false,
                modal:    true,
                title:    _('Edit: ') + line.name,
                width:    '95%',
                //minHeight: 250,
                buttons: [
                    {
                        text: _('Save'),
                        click: function () {
                            $(this).dialog('close');
                            $('.test-input').each(function () {
                                var $this = $(this);
                                var attr = $this.data('name');
                                if ($this.attr('type') === 'checkbox') {
                                    line[attr] = $this.prop('checked');
                                } else {
                                    line[attr] = $this.val();
                                }
                            });
                            callback(null, id, line);
                        }
                    },
                    {
                        text: _('Cancel'),
                        click: function () {
                            $(this).dialog('close');
                            callback('_canceled', id);
                        }
                    }
                ]
            });
            $('#dialog-edit-type').change(function () {
                var val = $(this).val() ;
                if (val === 'number' || val === 'commaNumber') {
                    $('#dialog-edit-factor').show();
                    $('#dialog-edit-offset').show();
                } else  {
                    $('#dialog-edit-factor').hide();
                    $('#dialog-edit-offset').hide();
                }
            });
            $('.test-input').change(showResult).each(function () {
                if ($(this).attr('type') !== 'checkbox' && $(this).prop('tagName') !== 'SELECT') $(this).keyup(function () {
                    $(this).trigger('change');
                });
            });
            $('#dialog-edit-test-text').change(showResult).keyup(function () {
                $(this).trigger('change');
            });
            $('#dialog-edit-show').button({
                icons: {primary: 'ui-icon-play'},
                text: false
            }) .css({width: '1.5em', height: '1.5em'}).click(function () {
                var select = $('#dialog-edit-test-text').data('select');
                if (select) $('#dialog-edit-test-text').scrollToText(select.pos, select.length);
            });
            $('#dialog-edit-substituteOld').change(function () {
                $('#dialog-edit-substitute').prop('disabled', $(this).prop('checked'));
            });
        }
        $('#dialog-edit-substitute').prop('disabled', line.substituteOld);
        $('#dialog-edit-type').trigger('change');

        $dialog.dialog('open');
    }

    // the function loadSettings has to exist ...
    function load(settings, onChange) {
        if (!settings) return;

        $('.value').each(function () {
            var key = $(this).attr('id');
            var $key = $('#' + key + '.value');
            if ($key.attr('type') === 'checkbox') {
                $key.prop('checked', settings[key]).on('change', function () {
                    onChange();
                });
            } else {
                $key.val(settings[key]).on('change', function () {
                    onChange();
                }).on('keyup', function () {
                    onChange();
                });
            }
        });

        onChange(false);

        $('.table-values').find('th[data-name="substituteOld"]').attr('title',  _('Use last value if cannot read'));

        var namespace = adapter + '.' + instance + '.';

        socket.emit('getObjectView', 'system', 'state', {startkey: namespace, endkey: namespace + '\u9999'}, function (err, res) {
            if (!err && res) {
                for (var i = 0; i < res.rows.length; i++) {
                    var obj = res.rows[i].value;
                    var line = {
                        name:          obj._id.substring(namespace.length),
                        link:          obj.native.link,
                        read:          obj.common.read,
                        write:         obj.common.write,
                        item:          obj.native.item || 0,
                        regex:         obj.native.regex,
                        role:          obj.common.role,
                        type:          obj.common.type,
                        unit:          obj.common.unit,
                        interval:      obj.native.interval,
                        substitute:    obj.native.substitute,
                        substituteOld: obj.native.substituteOld,
                        offset:        obj.native.offset,
                        factor:        obj.native.factor,
                        obj:           obj
                    };
                    if (line.type === 'number' && obj.native.comma) {
                        line.type = 'commaNumber';
                    }
                    values.push(line);
                }
            }

            var newValues = JSON.parse(JSON.stringify(values));
            var __values2table;
            if (typeof values2table !== 'undefined') __values2table = values2table;
            __values2table = __values2table || _values2table;
            __values2table('values', newValues, onChange, function () {
                if (!newValues.length) {
                    $('.table-button-add').trigger('click');
                }

                $('.values-input[data-name="name"]').change(function () {
                    var val = $(this).val();
                    var error = '';
                    if (!val) {
                        error = 'Empty names are not allowed';
                    } else if (val.indexOf(' ') !== -1) {
                        error = 'Spaces are not allowed';
                    }
                    if (error) {
                        $(this).addClass(error).attr('title', _(error));
                    } else {
                        $(this).removeClass('error').attr('title', '');
                    }
                });
                $('.values-input[data-name="type"]').change(function () {
                    var id = $(this).data('index');
                    var val = $(this).val();
                    if (val === 'number') {
                        $('.values-input[data-name="factor"][data-index="' + id + '"]').show();
                        $('.values-input[data-name="offset"][data-index="' + id + '"]').show();
                    } else {
                        $('.values-input[data-name="factor"][data-index="' + id + '"]').hide();
                        $('.values-input[data-name="offset"][data-index="' + id + '"]').hide();
                    }
                    if (val === 'boolean' || val === 'json') {
                        $('.values-input[data-name="unit"][data-index="' + id + '"]').hide();
                    } else {
                        $('.values-input[data-name="unit"][data-index="' + id + '"]').show();
                    }
                }).each(function () {
                    var id = $(this).data('index');
                    var val = $(this).val();
                    if (val === 'number') {
                        $('.values-input[data-name="factor"][data-index="' + id + '"]').show();
                        $('.values-input[data-name="offset"][data-index="' + id + '"]').show();
                    } else {
                        $('.values-input[data-name="factor"][data-index="' + id + '"]').hide();
                        $('.values-input[data-name="offset"][data-index="' + id + '"]').hide();
                    }
                    if (val === 'boolean' || val === 'json') {
                        $('.values-input[data-name="unit"][data-index="' + id + '"]').hide();
                    } else {
                        $('.values-input[data-name="unit"][data-index="' + id + '"]').show();
                    }

                });
                $('.values-input[data-name="substituteOld"]').change(function () {
                    $(this).parent().parent().find('.values-input[data-name="substitute"]').prop('disabled', $(this).prop('checked'));
                }).each(function () {
                    $(this).parent().parent().find('.values-input[data-name="substitute"]').prop('disabled', $(this).prop('checked'));
                });
            });
        });
    }

    function processTasks(tasks, cb) {
        if (!tasks || !tasks.length) {
            cb && cb();
            return;
        }

        var task = tasks.pop();

        if (typeof task === 'object') {
            socket.emit('setObject', task._id, task, function (err) {
                if (err) console.error(err);
                setTimeout(function () {
                    processTasks(tasks, cb);
                }, 0);
            });
        } else {
            socket.emit('delState', task, function (err) {
                if (err) console.error(err);
                socket.emit('delObject', task, function (err) {
                    if (err) console.error(err);
                    setTimeout(function () {
                        processTasks(tasks, cb);
                    }, 0);
                });
            });
        }
    }

    /*function editCron(value, cb) {
        //noinspection JSJQueryEfficiency
        var $dialogCron = $('#dialog-cron');
        if (!$dialogCron.length) {
            $('body').append('<div id="dialog-cron" style="display: none"><div id="div-cron"></div></div>');
            $dialogCron = $('#dialog-cron');
            $dialogCron.dialog({
                autoOpen:   false,
                modal:      true,
                width:      700,
                height:     550,
                resizable:  false,
                title:      _('Cron expression'),
                buttons: [
                    {
                        id:     'dialog_cron_insert',
                        text:   _('Insert'),
                        click:  function () {
                            var val = $('#div-cron').cron('value');
                            that.$dialogCron.dialog('close');
                            that.editor.insert('"' + val + '"');
                            that.editor.focus();
                        }
                    },
                    {
                        id:     'dialog_cron_clear',
                        text: _('Clear'),
                        click: function () {
                            $('#div-cron').cron('value', '');
                        }
                    },
                    {
                        id:     'dialog_cron_callback',
                        text:   _('Set CRON'),
                        click:  function () {
                        }
                    },
                    {
                        text: _('Cancel'),
                        click: function () {
                            that.$dialogCron.dialog('close');
                        }
                    }
                ]
            });
        }
        var $divCron = $('#div-cron');

        value = (value || '').replace(/"/g, '').replace(/'/g, '');
        try {
            $divCron.cron('value', value);
        } catch (e) {
            alert(_('Cannot parse value as cron'));
        }

        $('#dialog_cron_insert').hide();

        $('#dialog_cron_callback')
            .show()
            .unbind('click')
            .click(function () {
                var val = $divCron.cron('value');
                $dialogCron.dialog('close');
                if (cb) cb(val);
            });

        $dialogCron.dialog('open');
    }*/
    function save(callback) {
        var obj = {};
        $('.value').each(function () {
            var $this = $(this);
            if ($this.attr('type') === 'checkbox') {
                obj[$this.attr('id')] = $this.prop('checked');
            } else {
                obj[$this.attr('id')] = $this.val();
            }
        });
        var newValues;
        if (typeof table2values !== 'undefined') {
            newValues = table2values();
        } else {
            newValues = _table2values();
        }
        var tasks = [];
        for (var v = 0; v < newValues.length; v++) {
            if (!newValues[v].name) {
                showMessage(_('Empty names are not allowed'), _('Error'), 'alert');
                return;
            }
            var found = false;
            var t;
            // find same name in old values
            for (t = 0; t < values.length; t++) {
                if (values[t].name === newValues[v].name) {
                    found = true;
                    break;
                }
            }
            newValues[v].offset = parseFloat(newValues[v].offset) || 0;
            newValues[v].factor = parseFloat(newValues[v].factor) || 1;
            newValues[v].item   = parseFloat(newValues[v].item)   || 0;
            if (found) {
                var _obj = values[t].obj;
                var changed = false;
                if (_obj.common.write !== !!newValues[v].write) {
                    _obj.common.write = !!newValues[v].write;
                    changed = true;
                }
                if (_obj.common.read !== true) {
                    _obj.common.read = true;
                    changed = true;
                }
                if (_obj.common.unit !== newValues[v].unit) {
                    _obj.common.unit = newValues[v].unit;
                    changed = true;
                }
                var type = newValues[v].type;
                if (newValues[v].type === 'commaNumber') type = 'number';
                var comma = (newValues[v].type === 'commaNumber');
                if (_obj.common.type !== type) {
                    _obj.common.type = type;
                    changed = true;
                }
                _obj.native.comma = !!_obj.native.comma;
                if (_obj.native.comma !== comma) {
                    _obj.native.comma = comma;
                    changed = true;
                }
                if (_obj.common.role !== newValues[v].role) {
                    _obj.common.role = newValues[v].role;
                    changed = true;
                }
                if (_obj.native.link !== newValues[v].link) {
                    _obj.native.link = newValues[v].link;
                    changed = true;
                }
                if (_obj.native.regex !== newValues[v].regex) {
                    _obj.native.regex = newValues[v].regex;
                     changed = true;
                }
                if (_obj.native.interval !== newValues[v].interval) {
                    _obj.native.interval = newValues[v].interval;
                    changed = true;
                }
                if (_obj.native.item !== newValues[v].item) {
                    _obj.native.item = newValues[v].item;
                    changed = true;
                }
                if (_obj.native.substitute !== newValues[v].substitute) {
                    _obj.native.substitute = newValues[v].substitute;
                    changed = true;
                }
                if (_obj.native.substituteOld !== newValues[v].substituteOld) {
                    _obj.native.substituteOld = newValues[v].substituteOld;
                    changed = true;
                }
                if (_obj.native.factor !== newValues[v].factor) {
                    _obj.native.factor = newValues[v].factor;
                    changed = true;
                }
                if (_obj.native.offset !== newValues[v].offset) {
                    _obj.native.offset = newValues[v].offset;
                    changed = true;
                }
                if (changed) tasks.push(_obj);
            } else {
                tasks.push({
                    _id:            adapter + '.' + instance + '.' + newValues[v].name.replace(/\s/g, '_'),
                    common: {
                        name:           newValues[v].name,
                        write:          !!newValues[v].write,
                        read:           true,
                        unit:           newValues[v].unit,
                        type:           newValues[v].type,
                        role:           newValues[v].role
                    },
                    native: {
                        link:           newValues[v].link,
                        regex:          newValues[v].regex,
                        interval:       newValues[v].interval,
                        factor:         newValues[v].factor,
                        offset:         newValues[v].offset,
                        substitute:     newValues[v].substitute,
                        substituteOld:  newValues[v].substituteOld
                    },
                    type: 'state'
                });
            }
        }
        for (var w = 0; w < values.length; w++) {
            var found = false;
            for (var k = 0; k < newValues.length; k++) {
                if (values[w].name === newValues[k].name) {
                    found = true;
                    break;
                }
            }
            if (!found) {
                tasks.push(values[w].obj._id);
            }
        }

        processTasks(tasks, function () {
            values = newValues;
            callback(obj);
        });
    }
</script>
</head>
<body>
<div id="adapter-container">

    <table><tr><td><img src="parser.png"></td><td><h3 class="translate">Parser adapter settings</h3></td></tr></table>

    <table style="width: 100%;">
        <tr>
            <td style="width: 200px;"><label for="pollInterval" class="translate">Default poll interval: </label></td>
            <td style="width: 100px;"><input class="value" id="pollInterval" style="width: 100%"/></td>
            <td class="translate">ms</td>
        </tr>
        <tr>
            <td colspan="3">&nbsp;</td>
        </tr>
    </table>
    <div id="values" style="width: 100%; height: calc(100% - 205px)">
        <span style="display: inline-block; font-size: larger;" class="translate">Add rule: </span><button class="table-button-add" style="margin-left: 10px; width: 1.5em; height: 1.5em; display: inline-block"></button>
        <div style="width: 100%; height: calc(100% - 30px); overflow: auto;">
            <table class="table-values" style="width: 100%;">
                <thead>
                    <tr>
                        <th data-name="_index"     style="width: 30px"></th>
                        <th data-name="name"       style="width: 110px" data-style="width: 110px" class="translate">Name</th>
                        <!--th data-name="read"      style="width: 50px" data-type="checkbox" class="translate" data-def="true">Read</th-->
                        <!--th data-name="write"     style="width: 50px" data-type="checkbox" class="translate">Write</th-->
                        <th data-name="link"       style="width: 30%" class="translate">URL or file name</th>
                        <th data-name="regex"      style="width: 150px"  data-style1="width: 150px" class="translate">RegEx</th>
                        <th data-name="item"       style="width: 150px"  data-style1="width: 40px" data-type="number" class="translate">Item</th>
                        <th data-name="role"       style="width: 70px"  data-style1="width: 70px" data-type="select" data-def="state" data-options="state/default;/custom;temperature;value;blinds;switch;indicator" class="translate">Role</th>
                        <th data-name="type"       style="width: 70px"  data-style1="width: 70px" data-type="select" data-def="boolean" data-options="boolean;number;commaNumber;string;json" class="translate">Type</th>
                        <th data-name="unit"       style="width: 60px"  data-style="width: 60px" class="translate">Unit</th>
                        <th data-name="substituteOld" style="width: 60px"  data-type="checkbox" data-style="width: 40px" class="translate">Old</th>
                        <th data-name="substitute" style="width: 60px"  data-style="width: 60px" class="translate">Subs</th>
                        <th data-name="factor"     style="width: 60px"  data-style="width: 60px" class="translate" data-def="1">Factor</th>
                        <th data-name="offset"     style="width: 60px"  data-style="width: 60px" class="translate" data-def="0">Offset</th>
                        <th data-name="interval"   style="width: 60px"  data-style="width: 60px" class="translate translateT" title="Leave it empty if default interval is desired">Interval</th>
                        <th data-buttons="edit delete"  style="width: 60px"></th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <div id="dialog-test" style="display: none; width: 90%; height: 300px; min-height: 250px;">
        <table style="width: 100%;">
            <colgroup>
                <col width="150" />
                <col width="*"/>
            </colgroup>
            <!--tr><td><label for="dialog-edit-link"       class="translate">URL or file name</label>:</td><td style=""><input id="dialog-edit-link" style="width: 100%" type="text" data-name="link"></td></tr-->
            <tr><td><label for="dialog-edit-type" class="translate">Type</label>:</td><td style="">
                <select id="dialog-edit-type" style="width: 150px" class="test-input" data-name="type">
                    <option value="boolean" selected="">boolean</option>
                    <option value="number">number(.)</option>
                    <option value="commaNumber">number(,)</option>
                    <option value="string">string</option>
                    <option value="json">JSON</option>
                </select>
            </td></tr>
            <tr><td><label for="dialog-edit-substituteOld" class="translate">Old value</label>:</td><td style=""><input id="dialog-edit-substituteOld" class="test-input" type="checkbox" data-name="substituteOld"/></td><td class="admin-text" data-id="substituteOld"></td></tr>
            <tr><td><label for="dialog-edit-substitute"     class="translate">Substitute</label>:</td><td style=""><input id="dialog-edit-substitute" class="test-input" style="width: 150px" type="text" data-name="substitute"/></td><td class="admin-text" data-id="substitute"></td></tr>
            <tr><td><label for="dialog-edit-item"           class="translate">Item</label>:</td><td style=""><input id="dialog-edit-item" class="test-input" style="width: 60px;" type="number" data-name="item"/></td><td class="admin-text" data-id="item"></td></tr>
            <tr><td><label for="dialog-edit-factor"         class="translate">Factor</label>:</td><td style=""><input id="dialog-edit-factor" class="test-input" style="width: 60px; display: none;" type="text" data-name="factor"/></td><td class="admin-text"  data-id="factor"></td></tr>
            <tr><td><label for="dialog-edit-offset"         class="translate">Offset</label>:</td><td style=""><input id="dialog-edit-offset" class="test-input" style="width: 60px; display: none;" type="text" data-name="offset"/></td><td class="admin-text" data-id="offset"></td></tr>
            <tr><td><label for="dialog-edit-regex"          class="translate">RegEx</label>:</td><td style=""  colspan="2"><input id="dialog-edit-regex" class="test-input" style="width: calc(100% - 60px)" type="text" data-name="regex"/><button id="dialog-edit-show" style="float: right;"></button></td></tr>
            <tr><td></td><td id="dialog-edit-error" style="color: red" colspan="2"></td></tr>
            <tr><td><label for="dialog-edit-test-text"      class="translate">Test text</label>:</td><td style="" colspan="2"><textarea id="dialog-edit-test-text" style="width: 100%; height: 150px; resize: none;"></textarea></td></tr>
            <tr><td><label for="dialog-edit-result"         class="translate">Result</label>:</td><td style="" colspan="2"><input readonly id="dialog-edit-result" style="width: 100%" /></td></tr>
        </table>
    </div>
</div>
</body>
</html>
